

<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bookbuilderpy.git &#8212; bookbuilderpy 1.9.28 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css" />
    
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="canonical" href="https://thomasweise.github.io/bookbuilderpy/_modules/bookbuilderpy/git.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="/bookbuilderpy/_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">bookbuilderpy 1.9.28 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bookbuilderpy.git</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bookbuilderpy.git</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Tools for interacting with git.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">TimeoutExpired</span>  <span class="c1"># nosec</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Final</span>

<span class="kn">from</span> <span class="nn">bookbuilderpy.logger</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">bookbuilderpy.path</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">bookbuilderpy.shell</span> <span class="kn">import</span> <span class="n">shell</span>
<span class="kn">from</span> <span class="nn">bookbuilderpy.strings</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">datetime_to_datetime_str</span><span class="p">,</span>
    <span class="n">enforce_non_empty_str</span><span class="p">,</span>
    <span class="n">enforce_non_empty_str_without_ws</span><span class="p">,</span>
    <span class="n">enforce_url</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">bookbuilderpy.types</span> <span class="kn">import</span> <span class="n">type_error</span>
<span class="kn">from</span> <span class="nn">bookbuilderpy.versions</span> <span class="kn">import</span> <span class="n">TOOL_GIT</span><span class="p">,</span> <span class="n">has_tool</span>


<div class="viewcode-block" id="Repo"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo">[docs]</a><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Repo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An immutable record of a git repository.&quot;&quot;&quot;</span>

    <span class="c1">#: the repository path</span>
    <span class="n">path</span><span class="p">:</span> <span class="n">Path</span>
    <span class="c1">#: the repository url</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#: the commit</span>
    <span class="n">commit</span><span class="p">:</span> <span class="nb">str</span>
    <span class="c1">#: the date and time</span>
    <span class="n">date_time</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
                 <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">commit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">date_time</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the information about a repository.</span>

<span class="sd">        :param path: the path</span>
<span class="sd">        :param url: the url</span>
<span class="sd">        :param commit: the commit</span>
<span class="sd">        :param date_time: the date and time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">type_error</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">enforce_dir</span><span class="p">()</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="n">enforce_url</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;commit&quot;</span><span class="p">,</span>
                           <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span><span class="n">commit</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">40</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid commit: &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid commit information &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="si">}</span><span class="s2">&#39; for repo &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;date_time&quot;</span><span class="p">,</span>
                           <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">date_time</span><span class="p">))</span>
        <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found repository in path &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; with commit &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="si">}</span><span class="s2">&#39; for url &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; and &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;date &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">date_time</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Repo.download"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo.download">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">dest_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Repo&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Download a git repository.</span>

<span class="sd">        :param url: the repository url</span>
<span class="sd">        :param dest_dir: the destination directory</span>
<span class="sd">        :return: the repository information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_tool</span><span class="p">(</span><span class="n">TOOL_GIT</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">TOOL_GIT</span><span class="si">}</span><span class="s2">&#39; installation found.&quot;</span><span class="p">)</span>

        <span class="n">dest</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">ensure_dir_exists</span><span class="p">()</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">enforce_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; repository &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; to directory &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;starting to load</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2"> via &#39;</span><span class="si">{</span><span class="n">TOOL_GIT</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shell</span><span class="p">([</span><span class="n">TOOL_GIT</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;--depth&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">dest</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                  <span class="n">cwd</span><span class="o">=</span><span class="n">dest</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">TimeoutExpired</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;https://github.com&quot;</span><span class="p">):</span>
                <span class="n">url2</span> <span class="o">=</span> <span class="n">enforce_url</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ssh://git@</span><span class="si">{</span><span class="n">url</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timeout when loading url &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;, so we try &quot;</span>
                       <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">url2</span><span class="si">}</span><span class="s2">&#39; instead, but first delete &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">onerror</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">ensure_dir_exists</span><span class="p">()</span>
                <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39; deleted and created, now re-trying cloning.&quot;</span><span class="p">)</span>
                <span class="n">shell</span><span class="p">([</span><span class="n">TOOL_GIT</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;clone&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;--depth&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="n">url2</span><span class="p">,</span> <span class="n">dest</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                      <span class="n">cwd</span><span class="o">=</span><span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timeout when loading url &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;successfully finished loading</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Repo</span><span class="o">.</span><span class="n">from_local</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repo.from_local"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo.from_local">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_local</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                   <span class="n">url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Repo&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all the information from an local repository.</span>

<span class="sd">        :param path: the path to the repository</span>
<span class="sd">        :param url: the url</span>
<span class="sd">        :return: the repository information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_tool</span><span class="p">(</span><span class="n">TOOL_GIT</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;</span><span class="si">{</span><span class="n">TOOL_GIT</span><span class="si">}</span><span class="s2">&#39; installation found.&quot;</span><span class="p">)</span>

        <span class="n">dest</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">dest</span><span class="o">.</span><span class="n">enforce_dir</span><span class="p">()</span>

        <span class="n">logger</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;checking commit information of repo &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39; via &#39;</span><span class="si">{</span><span class="n">TOOL_GIT</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="n">stdout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">shell</span><span class="p">(</span>
            <span class="p">[</span><span class="n">TOOL_GIT</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="s2">&quot;--no-abbrev-commit&quot;</span><span class="p">,</span> <span class="s2">&quot;-1&quot;</span><span class="p">],</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span> <span class="n">wants_stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s*commit</span><span class="se">\\</span><span class="s2">s+(.+?)</span><span class="se">\\</span><span class="s2">s+&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span>
                          <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Did not find commit information in repo &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="n">commit</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s*Date:</span><span class="se">\\</span><span class="s2">s+(.+?)$&quot;</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Did not find date information in repo &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
        <span class="n">date_str</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">date_raw</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y %z&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_raw</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">type_error</span><span class="p">(</span><span class="n">date_raw</span><span class="p">,</span> <span class="s2">&quot;date_raw&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span>
        <span class="n">date_time</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime_to_datetime_str</span><span class="p">(</span><span class="n">date_raw</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found commit &#39;</span><span class="si">{</span><span class="n">commit</span><span class="si">}</span><span class="s2">&#39; and date/time &#39;</span><span class="si">{</span><span class="n">date_time</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
               <span class="sa">f</span><span class="s2">&quot;for repo &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;applying &#39;</span><span class="si">{</span><span class="n">TOOL_GIT</span><span class="si">}</span><span class="s2">&#39; to get url information.&quot;</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">shell</span><span class="p">(</span>
                <span class="p">[</span><span class="n">TOOL_GIT</span><span class="p">,</span> <span class="s2">&quot;-C&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="s2">&quot;--get&quot;</span><span class="p">,</span> <span class="s2">&quot;remote.origin.url&quot;</span><span class="p">],</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">dest</span><span class="p">,</span> <span class="n">wants_stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span>
                <span class="n">url</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/.git&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2">.git&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span><span class="n">url</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">logger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found url &#39;</span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39; for repo &#39;</span><span class="si">{</span><span class="n">dest</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ssh://git@github.com&quot;</span><span class="p">):</span>
                <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">url</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">Repo</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="n">date_time</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repo.get_base_url"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo.get_base_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_base_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the base url of this repository.</span>

<span class="sd">        :return: the base url of this repository</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="n">base_url_lower</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">base_url_lower</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ssh://git@github.&quot;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">base_url</span><span class="p">[</span><span class="mi">10</span><span class="p">:])</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">base_url_lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.git&quot;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">base_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">enforce_url</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repo.make_url"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo.make_url">[docs]</a>    <span class="k">def</span> <span class="nf">make_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an url relative to this repository.</span>

<span class="sd">        :param relative_path: the relative path</span>
<span class="sd">        :return: the url</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pt</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">resolve_inside</span><span class="p">(</span><span class="n">relative_path</span><span class="p">)</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">ensure_file_exists</span><span class="p">()</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">Final</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_url</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;github.com&quot;</span> <span class="ow">in</span> <span class="n">base_url</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/blob/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">enforce_url</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="Repo.get_name"><a class="viewcode-back" href="../../bookbuilderpy.html#bookbuilderpy.git.Repo.get_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the name of this repository in the form &#39;user/name&#39;.</span>

<span class="sd">        :return: the name of this repository in the form &#39;user/name&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url</span>
        <span class="k">if</span> <span class="n">base_url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.git&quot;</span><span class="p">):</span>
            <span class="n">base_url</span> <span class="o">=</span> <span class="n">enforce_non_empty_str_without_ws</span><span class="p">(</span><span class="n">base_url</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">si</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">base_url</span>
        <span class="n">si</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">base_url</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">si</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">enforce_non_empty_str</span><span class="p">(</span><span class="n">base_url</span><span class="p">[</span><span class="n">si</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">bookbuilderpy 1.9.28 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">bookbuilderpy.git</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021-2023, Thomas Weise.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    </div>
  </body>
</html>